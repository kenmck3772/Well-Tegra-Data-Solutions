<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Well-Tegra Data Solutions | Integrated Well Delivery Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; font-weight: 500; font-size: 16px; background-color: #0B1120; color: #E0E7FF; }
        h1, h2, h3, h4, h5, h6 { font-weight: 800; }
        
        .section-title {
            font-weight: 800;
            letter-spacing: -0.025em;
            background: linear-gradient(to right, #00C6FF, #0072FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stat-card, .light-card {
            background-color: rgba(23, 31, 51, 0.7);
            border: 1px solid #1E293B;
            backdrop-filter: blur(10px);
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            max-width: 500px;
            max-height: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .header {
            background-color: rgba(11, 17, 32, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #1E293B;
        }
        .nav-link {
            color: #94a3b8;
            font-size: 1rem;
            padding: 0.75rem 0.5rem;
            transition: color 0.3s, border-bottom-color 0.3s;
            border-bottom: 2px solid transparent;
        }
        .nav-link.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
            font-weight: 700;
        }
        .hero-section {
             background-color: #0B1120;
        }
        .hero-section h1 {
            color: white;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
        }
        .hero-section p {
            color: #E0E7FF;
             text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.3);
        }
        .accent-text { color: #2563eb; }
        .dark .accent-text { color: #60a5fa; }

        .mobilisation-card {
            border: 1px solid #334155;
            transition: all 0.3s ease;
        }
        .mobilisation-card.approved {
            border-color: #22c55e;
            background-color: rgba(34, 197, 94, 0.1);
        }
        
        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #1e293b;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 400px;
        }
        .performer-modal-view {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .performer-modal-content {
            background-color: #0B1120;
            border: 1px solid #1E293B;
            width: 95%;
            height: 95%;
            max-width: 1600px;
            border-radius: 0.75rem;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            display: flex;
            flex-direction: column;
        }
        .performer-view .dashboard-grid { 
            display: grid; 
            grid-template-columns: 2fr 5fr 3fr; 
            gap: 1.5rem; 
            height: 100%; 
            padding: 1.5rem;
        }
        .performer-view .kpi-card { background-color: #171F33; border-radius: 0.5rem; border: 1px solid #334155; color: #f8fafc; }
        .performer-view .procedure-step { border-left: 4px solid #475569; transition: all 0.3s; cursor: pointer; }
        .performer-view .procedure-step.active { background-color: rgba(96, 165, 250, 0.1); border-left-color: #60a5fa; }
        .performer-view .procedure-step.completed { border-left-color: #64748b; opacity: 0.6; }
        .performer-view .log-entry { border-bottom: 1px solid #334155; }
        .performer-view .alarm { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .faq-item details > summary {
            list-style: none;
        }
        .faq-item details > summary::-webkit-details-marker {
            display: none;
        }
    </style>
</head>
<body class="antialiased">

<div id="app-container" class="min-h-screen flex flex-col">
    <!-- Header -->
    <header id="app-header" class="header sticky top-0 z-30 transition-colors">
        <div class="max-w-full mx-auto py-3 px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <img src="assets/logo.png" alt="Well-Tegra Data Solutions Logo" class="h-14 w-auto mr-4">
                    <h1 id="header-title" class="text-2xl font-bold text-white hidden md:block">Well-Tegra Data Solutions</h1>
                </div>
                <div id="header-nav" class="flex-1 flex items-center justify-center space-x-2 md:space-x-6">
                    <a id="home-nav-link" title="Return to the Home Page" class="nav-link active flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                        <span>Home</span>
                    </a>
                    <a id="planner-nav-link" title="Go to the Well Intervention Planner" class="nav-link flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
                        <span>Planner</span>
                    </a>
                    <a id="logistics-nav-link" title="Manage Equipment and Personnel" class="nav-link flex items-center space-x-2">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M5 18H3c-.6 0-1-.4-1-1V7c0-.6.4-1 1-1h10c.6 0 1 .4 1 1v11"/><path d="M14 9h4l4 4v4h-8v-4h-4V9Z"/><path d="M18 18h-1.3c-.5 0-.9-.3-1.1-.7l-2.6-5"/><circle cx="7" cy="18" r="2"/><circle cx="17" cy="18" r="2"/></svg>
                        <span>Logistics</span>
                    </a>
                    <a id="commercial-nav-link" title="View Financial Dashboards" class="nav-link flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        <span>Commercial</span>
                    </a>
                    <a id="hse-nav-link" title="View Health, Safety, and Environment Data" class="nav-link flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                        <span>HSE & Risk</span>
                    </a>
                    <a id="pob-nav-link" title="View Personnel on Board and Emergency Response" class="nav-link flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        <span>POB & ER</span>
                    </a>
                    <a id="whitepaper-nav-link" title="Read Our Technical Whitepaper" class="nav-link flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
                        <span>Whitepaper</span>
                    </a>
                     <a id="faq-nav-link" title="Frequently Asked Questions" class="nav-link flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
                        <span>FAQ</span>
                    </a>
                    <a id="questionnaire-nav-link" title="Contact Us" class="nav-link flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M12 22a10 10 0 0 0 10-10H2a10 10 0 0 0 10 10z"/><path d="M2 12V7a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5"/><path d="M12 12v10"/><path d="M18.36 7.64A9 9 0 0 0 5.64 7.64"/></svg>
                        <span>Questionnaire</span>
                    </a>
                </div>
                <div id="header-details" class="flex items-center space-x-4">
                    <a href="https://translate.google.com/" target="_blank" title="Translate Website" class="text-indigo-200 hover:text-white transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-1">
        <!-- Home View -->
        <div id="home-view" class="view-container">
            <section class="hero-section py-20 px-4 relative">
                <div class="max-w-4xl mx-auto text-center relative z-10">
                    <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight">Stop Burning Time. Start Optimizing Wells.</h1>
                    <p class="mt-6 text-lg md:text-xl">The oil and gas industry loses over $38 million per asset annually to unplanned downtime. Your engineers spend more than 50% of their time wrangling data. The cause? A disconnected digital ecosystem.</p>
                    <p class="mt-4 text-lg md:text-xl font-semibold">Well-Tegra Data Solutions transforms your operational data from a liability into your most valuable asset.</p>
                </div>
            </section>
             <section class="py-20 px-4 bg-slate-900/50">
                <div class="max-w-5xl mx-auto relative z-10">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold tracking-tight text-white">Are You Paying the Hidden Taxes of Inefficiency?</h2>
                        <p class="mt-4 text-lg text-indigo-200">Your operations are being taxed by disconnected workflows you can't see on a balance sheet.</p>
                    </div>
                    <div class="mt-12 grid md:grid-cols-3 gap-8">
                        <div class="stat-card p-6 rounded-xl"><h3 class="text-xl font-bold text-white">The Data Wrangling Tax</h3><p class="mt-2 text-indigo-200">Your most valuable assets—your engineers—are forced to act as data clerks, wasting countless hours hunting for information in emails, correcting spreadsheet errors, and re-entering data from PDFs.</p></div>
                        <div class="stat-card p-6 rounded-xl"><h3 class="text-xl font-bold text-white">The NPT Tax</h3><p class="mt-2 text-indigo-200">Every moment of Non-Productive Time is a direct hit to your bottom line. Plans based on poor data lead to equipment failures, procedural errors, and costly downtime.</p></div>
                        <div class="stat-card p-6 rounded-xl"><h3 class="text-xl font-bold text-white">The Collaboration Tax</h3><p class="mt-2 text-indigo-200">The critical gap between your team and service partners is where value is lost. Static PDF handoffs create slow, error-prone workflows that prevent true, real-time collaboration.</p></div>
                    </div>
                </div>
            </section>
        </div>
        
        <div id="planner-view" class="view-container hidden max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
             <div class="text-center mb-12"><h2 class="text-4xl section-title">Well Intervention Planner</h2></div>
            <div class="mb-12 light-card p-6 rounded-lg">
                <h3 class="text-xl font-bold text-white mb-2">A Quick Guide to the Demo</h3>
                <ol class="list-decimal list-inside text-indigo-200 space-y-1">
                    <li><strong>Home:</strong> This gives a brief overview of the value proposition.</li>
                    <li><strong>Planner:</strong> This is the core of the simulation. You can walk through the 3-step process of planning a well intervention. In Step 2, you can toggle the "AI Advisor" on to see how the system can provide intelligent recommendations.</li>
                    <li><strong>Performer (Picture-in-Picture):</strong> After generating a plan in the Planner, clicking "Begin Live Operation" will open the live dashboard in a modal window. This was designed to show how a team can monitor live operations without losing the context of the main application.</li>
                    <li><strong>HSE & POB:</strong> These modules are now populated with sample data to demonstrate how they would function.</li>
                    <li><strong>Whitepaper:</strong> This section contains the full executive summary and a simplified explanation of the underlying technology (Blockchain, Smart Contracts, etc.). The full PDF is also available for download here.</li>
                </ol>
            </div>
            <div class="mb-12 flex items-center justify-center space-x-4"><div id="step-1-indicator" class="step-indicator w-10 h-10 rounded-full flex items-center justify-center font-bold">1</div><div class="flex-1 h-1 bg-gray-700 rounded-full"></div><div id="step-2-indicator" class="step-indicator bg-gray-700 text-gray-500 w-10 h-10 rounded-full flex items-center justify-center font-bold">2</div><div class="flex-1 h-1 bg-gray-700 rounded-full"></div><div id="step-3-indicator" class="step-indicator bg-gray-700 text-gray-500 w-10 h-10 rounded-full flex items-center justify-center font-bold">3</div></div>
            <section id="step-1"><div class="text-center"><h2 class="text-3xl font-bold tracking-tight">Step 1: Select a Well</h2><p class="mt-2 max-w-2xl mx-auto text-lg">Choose a candidate well for the intervention plan.</p></div><div id="well-selection-grid" class="mt-10 grid gap-8 md:grid-cols-2 lg:grid-cols-3"></div></section>
            <section id="step-2" class="hidden"><div class="text-center"><h2 class="text-3xl font-bold tracking-tight">Step 2: Define Intervention Plan</h2><p class="mt-2 max-w-2xl mx-auto text-lg">Choose a planning method to define the primary goal for this intervention.</p></div><div class="mt-8 max-w-4xl mx-auto"><div class="flex items-center justify-center mb-6"><span class="text-sm font-medium mr-3">Manual Planning</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="ai-toggle" class="sr-only peer"><div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-teal-300 dark:peer-focus:ring-teal-800 dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-600"></div></label><span class="text-sm font-medium ml-3">✨ AI Advisor</span></div><div id="manual-planning-view"><fieldset id="objectives-fieldset" class="space-y-4"></fieldset><div class="mt-8 flex justify-center"><button id="generate-plan-btn-manual" class="rounded-md bg-teal-600 px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-teal-500 disabled:bg-gray-400" disabled>Generate Plan</button></div></div><div id="ai-advisor-view" class="hidden"><div id="problem-selection"><h3 class="text-lg font-semibold text-center mb-4">What is the primary problem with this well?</h3><fieldset id="problems-fieldset" class="space-y-4"></fieldset></div><div id="ai-recommendations" class="hidden mt-8"></div><div class="mt-8 flex justify-center"><button id="generate-plan-btn-ai" class="rounded-md bg-teal-600 px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-teal-500 disabled:bg-gray-400" disabled>Generate Plan from Recommendation</button></div></div></div></section>
            <section id="step-3" class="hidden"><div class="text-center"><h2 class="text-3xl font-bold tracking-tight">Step 3: Review the Generated Plan</h2><p class="mt-2 max-w-2xl mx-auto text-lg">This is the initial, data-driven plan. Review and then begin the live operation.</p></div><div id="plan-output" class="mt-10 light-card p-6 md:p-8 space-y-8 rounded-lg"></div><div class="mt-8 flex justify-center space-x-4"><button id="start-over-btn" class="rounded-md bg-gray-600 px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-gray-500">Start Over</button><button id="begin-op-btn" class="rounded-md bg-emerald-600 px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-emerald-500">Begin Live Operation</button></div></section>
        </div>

        <div id="logistics-view" class="view-container hidden max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
             <div class="text-center mb-12"><h2 class="text-4xl section-title">Logistics & Asset Management</h2></div>
            <div class="mt-10 grid gap-12 lg:grid-cols-2">
                <div class="light-card p-6 rounded-lg"><h3 class="text-xl font-semibold mb-4">Equipment Hub</h3><input type="text" id="equipment-search" placeholder="Search equipment..." class="w-full p-2 rounded-md mb-4"><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="table-header"><tr><th class="p-2">Asset ID</th><th>Type</th><th>Location</th><th>Test Status</th><th>Actions</th></tr></thead><tbody id="equipment-table-body"></tbody></table></div></div>
                <div class="light-card p-6 rounded-lg"><h3 class="text-xl font-semibold mb-4">Personnel Roster</h3><input type="text" id="personnel-search" placeholder="Search personnel..." class="w-full p-2 rounded-md mb-4"><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="table-header"><tr><th class="p-2">Name</th><th>Role</th><th>Status</th><th>Certs Valid</th></tr></thead><tbody id="personnel-table-body"></tbody></table></div></div>
            </div>
        </div>
        
        <div id="commercial-view" class="view-container hidden max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
             <div class="text-center mb-12"><h2 class="text-4xl section-title">Commercial Dashboard</h2></div>
            <div id="commercial-content" class="mt-10"></div>
        </div>

        <div id="hse-view" class="view-container hidden max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12"><h2 class="text-4xl section-title">HSE & Risk Dashboard</h2></div>
            <div id="hse-content" class="mt-10"></div>
        </div>

        <div id="pob-view" class="view-container hidden max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12"><h2 class="text-4xl section-title">Personnel on Board & Emergency Response</h2></div>
            <div id="pob-content" class="mt-10"></div>
        </div>

        <div id="whitepaper-view" class="view-container hidden max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
            <div class="text-center"><h2 class="text-4xl section-title">Our Data-Driven Framework</h2><p class="mt-2 max-w-2xl mx-auto text-lg text-indigo-200">Learn how we transform well delivery from a reactive process to a predictive science.</p></div>
            <div class="mt-10 light-card p-8 rounded-lg">
                <h3 class="text-2xl font-bold mb-4 text-white">Executive Summary</h3>
                <p class="mb-4 text-indigo-200">The development of HPHT reservoirs is defined by extreme conditions and critically narrow operational margins. Failure to adequately model, manage, and mitigate the associated geomechanical risks invariably leads to catastrophic cost overruns and destruction of project value.</p>
                <p class="mb-4 text-indigo-200">The Well-Tegra platform provides an integrated strategy, creating a single source of truth that inextricably links subsurface geomechanics, well trajectory design, advanced drilling fluid engineering, and risk-based economic modeling. Our platform ensures that each discipline informs and constrains the others in a continuous feedback loop, which is essential for de-risking investment and assuring well delivery.</p>
                <a href="assets/well-tegra-whitepaper.pdf" target="_blank" class="inline-flex items-center rounded-md bg-blue-600 px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-blue-500 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                    Download Full Whitepaper
                </a>
            </div>
            <div class="mt-12 light-card p-8 rounded-lg">
                <h3 class="text-2xl font-bold mb-4 text-white">How It Works: The Technology Explained</h3>
                <div class="space-y-6 text-left">
                    <div>
                        <h4 class="text-xl font-semibold" style="color: #00C6FF;">How Blockchain Guarantees Security</h4>
                        <p class="mt-2 text-indigo-200">At its core, a blockchain is a digital record book that is incredibly difficult to tamper with. Its security comes from three interconnected concepts:</p>
                        <ul class="list-disc list-inside mt-2 space-y-1 text-indigo-200">
                            <li><strong>Cryptographic Hashing (The Digital Fingerprint):</strong> Every block of data gets a unique code. If even a single character changes, the code changes completely, making tampering obvious.</li>
                            <li><strong>Block Chaining (An Unbreakable Chain):</strong> Each new block contains the fingerprint of the one before it. Altering a past block breaks the entire chain, which the network instantly rejects.</li>
                            <li><strong>Decentralization (Strength in Numbers):</strong> The record book is copied and distributed across all members. To make a fraudulent change, a hacker would need to control a majority of the computers simultaneously, which is practically impossible.</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="text-xl font-semibold" style="color: #00C6FF;">How Smart Contracts Work: Your Digital Rulebook</h4>
                        <p class="mt-2 text-indigo-200">A smart contract is like a digital vending machine. It's a program on the blockchain that automatically enforces an agreement based on "if-then" logic. For Well-Tegra, a rule might be: "IF a user has the 'Analyst' role, THEN they are allowed to query the anonymized data pool." It runs automatically and is tamper-proof.</p>
                    </div>
                     <div>
                        <h4 class="text-xl font-semibold" style="color: #00C6FF;">Future-Proof Security: Quantum Ready</h4>
                        <p class="mt-2 text-indigo-200">While today's encryption is strong, we build for the future. The rise of quantum computing threatens to break current security standards. Our platform is **quantum-ready**, meaning its cryptographic components are modular and can be seamlessly upgraded to new, quantum-resistant algorithms as they become available, ensuring your data remains secure for decades to come.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="faq-view" class="view-container hidden max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12"><h2 class="text-4xl section-title">Frequently Asked Questions</h2></div>
            <div id="faq-container" class="space-y-4"></div>
        </div>

        <div id="questionnaire-view" class="view-container hidden max-w-4xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12"><h2 class="text-4xl section-title">Contact & Questionnaire</h2><p class="mt-2 text-lg text-indigo-200">Interested in learning more? Fill out the form below to start the conversation.</p></div>
            <form id="questionnaire-form" class="light-card p-8 rounded-lg space-y-6">
                <div><label for="companyName" class="block text-sm font-medium text-indigo-100">Company Name</label><input type="text" id="companyName" class="mt-1 block w-full rounded-md bg-slate-800 border-slate-600 text-white p-2"></div>
                <div><label for="role" class="block text-sm font-medium text-indigo-100">Your Role</label><input type="text" id="role" class="mt-1 block w-full rounded-md bg-slate-800 border-slate-600 text-white p-2"></div>
                <div><label for="challenges" class="block text-sm font-medium text-indigo-100">What are your biggest challenges with operational data?</label><textarea id="challenges" rows="4" class="mt-1 block w-full rounded-md bg-slate-800 border-slate-600 text-white p-2"></textarea></div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-md hover:bg-blue-700 transition">Submit Inquiry</button>
            </form>
            <p id="form-submission-message" class="text-center mt-4 text-green-400 hidden">Thank you for your interest! We will be in touch shortly.</p>
        </div>
    </main>
    
    <div id="performer-modal" class="performer-modal-view hidden">
        <div class="performer-modal-content">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                 <h2 class="text-2xl font-bold text-white">Live Operations Dashboard</h2>
                 <button id="close-performer-btn" class="text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
            </div>
            <div id="performer-view" class="performer-view flex-1">
                <div class="dashboard-grid">
                    <div id="procedure-panel" class="light-card p-4 flex flex-col">
                        <h3 class="text-lg font-semibold mb-2 border-b border-slate-700 pb-2">Operational Procedure</h3>
                        <p class="text-xs text-slate-400 mb-3">Click a future step to advance the simulation.</p>
                        <div id="procedure-steps" class="flex-1 space-y-3 overflow-y-auto pr-2"></div>
                        <div id="performer-controls" class="hidden mt-4">
                            <button id="view-analysis-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-md transition">View Post-Job Analysis</button>
                        </div>
                    </div>
                    <div class="flex flex-col gap-4 lg:gap-6">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 lg:gap-6">
                            <div class="kpi-card p-4"><p class="text-sm">Hookload (klbf)</p><p id="kpi-hookload" class="text-3xl font-bold">0.0</p></div>
                            <div class="kpi-card p-4"><p class="text-sm">Pump Pressure (psi)</p><p id="kpi-pressure" class="text-3xl font-bold">0</p></div>
                            <div class="kpi-card p-4"><p class="text-sm">CT Speed (ft/min)</p><p id="kpi-speed" class="text-3xl font-bold">0</p></div>
                            <div class="kpi-card p-4"><p class="text-sm">Depth (ft)</p><p id="kpi-depth" class="text-3xl font-bold">0</p></div>
                        </div>
                        <div id="chart-card" class="flex-1 light-card p-4 flex flex-col"><h3 class="text-lg font-semibold mb-2">Tubing Force Analysis: Plan vs. Actual</h3><div class="flex-1 relative"><canvas id="tfaChart"></canvas></div></div>
                        <div id="manual-controls" class="light-card p-4 flex items-center justify-center space-x-4">
                            <button id="step-backward-btn" class="rounded-md bg-slate-600 px-6 py-2 text-base font-semibold text-white shadow-sm hover:bg-slate-500 disabled:opacity-50" disabled>Step Back</button>
                            <button id="step-forward-btn" class="rounded-md bg-teal-600 px-6 py-2 text-base font-semibold text-white shadow-sm hover:bg-teal-500">Step Forward</button>
                        </div>
                    </div>
                    <div class="light-card p-4 flex flex-col"><h3 class="text-lg font-semibold mb-4 border-b border-slate-700 pb-2">Operations Log</h3><div id="log-entries" class="flex-1 space-y-3 overflow-y-auto mb-4"></div><div class="mt-auto"><textarea id="log-input" class="w-full bg-slate-900 border border-slate-600 rounded-md p-2 text-sm" rows="3" placeholder="Add log entry..."></textarea><button id="add-log-btn" class="mt-2 w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded-md transition">Add Entry</button></div></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="well-history-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 modal-overlay">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-5xl shadow-lg rounded-md modal-content">
            <div class="flex justify-between items-center border-b pb-3 dark:border-gray-700">
                <h3 id="modal-title" class="text-2xl font-bold"></h3>
                <button id="close-modal-btn" class="text-3xl font-bold hover:text-red-500">&times;</button>
            </div>
            <div id="modal-content" class="mt-4 max-h-[80vh] overflow-y-auto p-1"></div>
        </div>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- DATA STORE (Sample Data for Simulation) ---
    const wellData = [
        { 
            id: 'W666', 
            name: 'The Well From Hell',
            api: '666',
            field: 'Devils Basin', 
            region: 'UKCS', 
            type: 'HPHT Gas Condensate', 
            depth: '18,500ft', 
            status: 'Drilling - Critical Section', 
            issue: 'Extreme overpressure and borehole stability issues in the Hades Shale formation.', 
            history: [ 
                { date: '2025-06-28', operation: 'Ran 9-5/8" Casing', problem: 'Experienced severe losses while cementing. Required multiple top-up jobs.', lesson: 'The fracture gradient in this area is even lower than predicted. Future cement jobs must use ultra-lightweight slurry and precision placement techniques.' }, 
                { date: '2025-06-15', operation: 'Drilling 12-1/4" Hole', problem: 'Encountered multiple pack-off and stuck pipe events in the Hades Shale. 48 hours of NPT.', lesson: 'The Hades Shale is mechanically weak and highly reactive. Requires SBM with maximum inhibition and a tightly controlled ROP to minimize cuttings buildup.' } 
            ], 
            dailyReports: [ 
                { date: '2025-07-07', summary: 'Drilling 8-1/2" hole. Experiencing intermittent high torque and drag. Mud weight at 17.8 ppg, just 0.2 ppg below estimated fracture gradient.', npt: 2.0 }, 
                { date: '2025-07-08', summary: 'Lost circulation event. Lost 300 bbls of SBM. Pumping LCM pills to cure losses. Preparing to pull back and perform a remedial cement job.', npt: 8.5 } 
            ], 
            completion: { 
                casing: [
                    {type: 'Conductor', size: '30', top: 0, bottom: 500}, 
                    {type: 'Surface', size: '20', top: 0, bottom: 2500}, 
                    {type: 'Intermediate', size: '13 3/8', top: 0, bottom: 9500},
                    {type: 'Production Liner', size: '9 5/8', top: 9200, bottom: 15000}
                ], 
                tubing: [{type: 'Production', size: '4 1/2', top: 0, bottom: 17800}], 
                equipment: [
                    {item: 'Liner Hanger Packer', top: 9200, comments: 'Hydraulic Set'},
                    {item: 'SSSV', top: 12500, comments: 'TRSSSV, Flapper'}, 
                    {item: 'Permanent Packer', top: 17750, comments: 'HPHT Permanent Packer'},
                    {item: 'Hades Shale Formation', top: 14000, comments: 'Highly Stressed, Prone to Collapse', isProblem: true}
                ], 
                perforations: [{top: 18000, bottom: 18250, date: 'N/A'}] 
            } 
        },
        { id: 'W001', name: 'Gullfaks C-34', field: 'Gullfaks', region: 'Norwegian Sector', type: 'Oil Producer', depth: '2,850m', status: 'Active - Underperforming', issue: 'Suspected scale buildup in tubing.', history: [ { date: '2022-05-12', operation: 'Slickline Plug Set', problem: 'Minor delays due to weather.', lesson: 'Allocate more buffer time for weather in North Sea operations during spring.' }, { date: '2020-10-03', operation: 'Scale Inhibitor Squeeze', problem: 'Pump failure led to 12 hours of NPT.', lesson: 'Increase preventative maintenance frequency on pump units.' } ], dailyReports: [ { date: '2022-05-12', summary: 'RIH to set plug. Encountered minor weather delays.', npt: 2.5 }, { date: '2022-05-13', summary: 'Set plug successfully. POOH. Job complete.', npt: 0 } ], completion: { casing: [{type: 'Surface', size: '13 3/8', top: 0, bottom: 800}, {type: 'Production', size: '9 5/8', top: 0, bottom: 2850}], tubing: [{type: 'Production', size: '4 1/2', top: 0, bottom: 2750}], equipment: [{item: 'SSSV', top: 1200, comments: 'TRSSSV, Flapper'}, {item: 'Packer', top: 2700, comments: 'Hydraulic Set'}, {item: 'Scale Buildup', top: 2300, comments: 'Suspected from history', isProblem: true}], perforations: [{top: 2800, bottom: 2820, date: '2019-03-10'}] } },
        { id: 'W002', name: 'Statfjord A-12', field: 'Statfjord', region: 'Norwegian Sector', type: 'Water Injector', depth: '3,100m', status: 'Active - Low Injectivity', issue: 'Possible perforation plugging.', history: [ { date: '2023-01-20', operation: 'Coiled Tubing Acid Wash', problem: 'Incorrect acid concentration mixed initially.', lesson: 'Implement double-check verification for all fluid mixtures.' } ], dailyReports: [ { date: '2023-01-20', summary: 'Rig up CTU. Mixed acid, identified concentration error. Remixed. NPT: 3 hours.', npt: 3 }, { date: '2023-01-21', summary: 'RIH, spotted acid. POOH. Job complete.', npt: 0 } ], completion: { casing: [{type: 'Production', size: '9 5/8', top: 0, bottom: 3100}], tubing: [{type: 'Injection', size: '4 1/2', top: 0, bottom: 3000}], equipment: [{item: 'Packer', top: 2950, comments: 'Hydraulic Set'}], perforations: [{top: 3050, bottom: 3080, date: '2017-05-20', comments: 'Partially plugged', isProblem: true}] } },
        { id: 'W003', name: 'Oseberg B-21', field: 'Oseberg', region: 'Norwegian Sector', type: 'Gas Producer', depth: '2,500m', status: 'Shut-in', issue: 'Suspected downhole safety valve failure.', history: [ { date: '2021-08-05', operation: 'Routine DHSV Test', problem: 'Valve failed to close on first attempt.', lesson: 'DHSV shows early signs of wear; schedule for replacement in next planned intervention.' } ], dailyReports: [ { date: '2021-08-05', summary: 'Performed routine DHSV test. Valve failed initial closure command. Cycled valve multiple times, eventually closed. Recommend monitoring.', npt: 1.5 } ], completion: { casing: [{type: 'Production', size: '7', top: 0, bottom: 2500}], tubing: [{type: 'Production', size: '3 1/2', top: 0, bottom: 2400}], equipment: [{item: 'SSSV', top: 1000, comments: 'Failed to close on test', isProblem: true}, {item: 'Packer', top: 2350, comments: 'Mechanical Set'}], perforations: [{top: 2450, bottom: 2480, date: '2018-01-15'}] } },
        { id: 'W004', name: 'Halfdan D-5', field: 'Halfdan', region: 'Danish Sector', type: 'Oil Producer', depth: '2,200m', status: 'P&A Candidate', issue: 'High water cut; uneconomical production.', history: [ { date: '2022-09-18', operation: 'Zonal Isolation Evaluation', problem: 'Logging tool failure downhole (NPT event).', lesson: 'Ensure all electronic tools are surface-tested for 4 hours prior to RIH.' } ], dailyReports: [], completion: { casing: [{type: 'Surface', size: '13 3/8', top: 0, bottom: 500}, {type: 'Production', size: '9 5/8', top: 0, bottom: 2200}], plugs: [{type: 'Surface Plug', top: 50, bottom: 100, material: 'Cement'}, {type: 'Intermediate Plug', top: 1200, bottom: 1300, material: 'Cement'}, {type: 'Reservoir Plug', top: 2100, bottom: 2200, material: 'Cement'}] } },
    ];
    const objectivesData = [ { id: 'obj1', name: 'Production Enhancement', description: 'Intervention to increase hydrocarbon flow rate.' }, { id: 'obj2', name: 'Water Shut-off', description: 'Isolate water-producing zones to reduce water cut.' }, { id: 'obj3', name: 'Well Integrity Restoration', description: 'Repair or replace failed downhole components.' }, { id: 'obj4', name: 'Plug & Abandonment', description: 'Permanently seal the wellbore.' }, ];
    const problemsData = [ { id: 'prob1', name: 'Production Decline / Low Injectivity', description: 'Well performance is below expected levels.', linked_objectives: ['obj1'] }, { id: 'prob2', name: 'Well Integrity Concern', description: 'Suspected failure of a downhole component (e.g., DHSV, packer).', linked_objectives: ['obj3'] }, { id: 'prob3', name: 'End of Life / Uneconomical', description: 'Well is no longer commercially viable.', linked_objectives: ['obj4', 'obj2'] }, ];
    const proceduresData = {
        obj1: { name: "Coiled Tubing Acid Stimulation", personnel: ["Coiled Tubing Supervisor", "Pump Operator", "Wellsite Engineer"], steps: ["Hold pre-job safety meeting & TBT.", "Confirm all PTW are approved.", "Rig up Coiled Tubing unit and PCE.", "Pressure test PCE to 5000 psi.", "Run in hole (RIH) to 9,500 ft.", "Spot 50 bbls of 15% HCl acid.", "Pull out of hole (POOH) to surface.", "Flow back well and monitor returns.", "Rig down equipment."], tooling: ["Coiled Tubing Unit", "High-Pressure Pumps", "Fluid Tanks", "Jetting Nozzle BHA", "Wellhead Pressure Control Equipment", "Data Acquisition System"], risks: { operational: 4, geological: 3, equipment: 3, hse: 4, financial: 2 }, cost: 750000, duration: 5, tfaModel: { pickUp: [[0,0], [9500, 25]], slackOff: [[0,0], [9500, -25]], alarmUpper: [[0,2], [9500, 27]], alarmLower: [[0,-2], [9500, -27]] } },
        obj2: { name: "Mechanical Plug Installation", personnel: ["Wireline Supervisor", "Wireline Operator"], steps: ["Hold pre-job safety meeting & TBT.", "Confirm all PTW are approved.", "Rig up Wireline unit.", "Run in hole with gauge ring.", "Run in hole with bridge plug and set at target depth.", "Dump bail cement on top of plug.", "Pressure test to confirm seal.", "Rig down equipment."], tooling: ["Wireline Truck/Skid", "Pressure Control Equipment (Lubricator)", "Setting Tool for Bridge Plug", "Gauge Rings", "Dump Bailer"], risks: { operational: 3, geological: 2, equipment: 3, hse: 3, financial: 1 }, cost: 325000, duration: 3, tfaModel: { pickUp: [[0,0], [9500, 10]], slackOff: [[0,0], [9500, -10]], alarmUpper: [[0,1], [9500, 11]], alarmLower: [[0,-1], [9500, -11]] } },
        obj3: { name: "DHSV Replacement via Slickline", personnel: ["Slickline Supervisor", "Slickline Operator"], steps: ["Hold pre-job safety meeting & TBT.", "Confirm all PTW are approved.", "Rig up Slickline unit.", "Run in hole to equalize and retrieve failed DHSV insert.", "Run in hole with new DHSV insert and lock into place.", "Pressure test control line and valve.", "Function test valve.", "Rig down equipment."], tooling: ["Slickline Unit", "DHSV Pulling/Running Tools", "Hydraulic Control Unit for DHSV"], risks: { operational: 4, geological: 1, equipment: 5, hse: 4, financial: 3 }, cost: 480000, duration: 5, tfaModel: { pickUp: [[0,0], [9500, 5]], slackOff: [[0,0], [9500, -5]], alarmUpper: [[0,1], [9500, 6]], alarmLower: [[0,-1], [9500, -6]] } },
        obj4: { name: "P&A - Section Milling & Plugging", personnel: ["Rig Supervisor", "Driller", "Derrickhand", "Floorhand"], steps: ["Hold pre-job safety meeting & TBT.", "Confirm all PTW are approved.", "Rig up workover rig.", "Mill section of casing to expose formation.", "Set balanced cement plug across milled section.", "Verify plug placement and integrity.", "Repeat for all required barriers.", "Rig down equipment."], tooling: ["Workover Rig", "Milling BHA (Motor & Mill)", "Cementing Unit", "Casing Scrapers & Brushes"], risks: { operational: 5, geological: 4, equipment: 4, hse: 5, financial: 4 }, cost: 2500000, duration: 18, tfaModel: { pickUp: [[0,0], [5000, 50]], slackOff: [[0,0], [5000, -50]], alarmUpper: [[0,10], [5000, 60]], alarmLower: [[0,-10], [5000, -60]] } }
    };
    const equipmentData = [ { id: 'CTU-01', type: 'Coiled Tubing Unit', location: 'Onboard - Deck A', testStatus: 'Passed', nextMaint: '2025-09-15', rate: 25000, status: 'On Job' }, { id: 'CTU-02', type: 'Coiled Tubing Unit', location: 'Onshore Base', testStatus: 'Pending', nextMaint: '2025-07-10', rate: 25000, status: 'Maintenance' }, { id: 'WL-01', type: 'Wireline Truck/Skid', location: 'Onshore Base', testStatus: 'Passed', nextMaint: '2025-08-22', rate: 18000, status: 'Available' }, { id: 'SL-01', type: 'Slickline Unit', location: 'In Transit', testStatus: 'Passed', nextMaint: '2025-07-20', rate: 15000, status: 'In Transit' }, { id: 'PUMP-01', type: 'High-Pressure Pumps', location: 'Onboard - Pump Room', testStatus: 'Pending', nextMaint: '2025-10-01', rate: 8000, status: 'On Job' }, { id: 'PUMP-02', type: 'High-Pressure Pumps', location: 'Onshore Base', testStatus: 'Passed', nextMaint: '2025-11-05', rate: 8000, status: 'Available' }, { id: 'RIG-01', type: 'Workover Rig', location: 'Onboard - Drill Floor', testStatus: 'Passed', nextMaint: '2025-08-01', rate: 85000, status: 'On Job' }, ];
    const personnelData = [ { id: 'P001', name: 'Bob Raker', role: 'Wellsite Engineer', company: 'Operator', status: 'Onboard', certsValid: true, rate: 2200, muster: 'A', lifeboat: 1 }, { id: 'P002', name: 'Jane Smith', role: 'Coiled Tubing Supervisor', company: 'Service Co.', status: 'Onboard', certsValid: true, rate: 2500, muster: 'A', lifeboat: 1 }, { id: 'P003', name: 'Mike Johnson', role: 'Wireline Supervisor', company: 'Service Co.', status: 'On Job', certsValid: true, rate: 2300, muster: 'B', lifeboat: 2 }, { id: 'P004', name: 'Emily White', role: 'Slickline Supervisor', company: 'Service Co.', status: 'Available', certsValid: false, rate: 2300, muster: 'B', lifeboat: 2 }, { id: 'P005', name: 'Chris Green', role: 'Pump Operator', company: 'Service Co.', status: 'In Transit', certsValid: true, rate: 1800, muster: 'A', lifeboat: 1 }, { id: 'P006', name: 'Alex Brown', role: 'Rig Supervisor', company: 'Operator', status: 'Onboard', certsValid: true, rate: 3000, muster: 'B', lifeboat: 2 }, ];
    const musterStations = [ { id: 'A', name: 'Muster Station A', capacity: 50, current: 0 }, { id: 'B', name: 'Muster Station B', capacity: 50, current: 0 } ];
    
    // --- GLOBAL STATE ---
    let appState = {
        currentView: 'home', selectedWell: null, selectedObjective: null, generatedPlan: null, liveData: null, logEntries: [], lessonsLearned: [], tfaChartInstance: null, nptChartInstance: null, savingsChartInstance: null,
        commercial: { afe: 0, actualCost: 0, serviceTickets: [] },
        ai: { selectedProblemId: null, selectedRecommendation: null },
        hse: { permits: [], riskRegister: [] },
        pob: { musterActive: false, musterInterval: null, personnel: [] }
    };

    // --- DOM ELEMENTS ---
    let body, views, navLinks, headerTitle, headerDetails, headerNav;
    let stepIndicators, stepSections, wellSelectionGrid, objectivesFieldset, problemsFieldset;
    let generatePlanBtnManual, generatePlanBtnAi, planOutput, startOverBtn, beginOpBtn;
    let aiToggle, manualPlanningView, aiAdvisorView, aiRecommendationsContainer;
    let performerModal, closePerformerBtn, kpiHookload, kpiPressure, kpiSpeed, kpiDepth;
    let procedureStepsContainer, logEntriesContainer, logInput, addLogBtn;
    let chartCard, performerControls, viewAnalysisBtn, stepForwardBtn, stepBackwardBtn;
    let analyzerSubtitle, summaryKpis, lessonsLearnedList, lessonInput, addLessonBtn, planNewJobBtn;
    let equipmentTableBody, personnelTableBody, equipmentSearch, personnelSearch;
    let commercialContent, commercialSubtitle;
    let hseContent, hseSubtitle;
    let pobContent;
    let modal, modalTitle, modalContent, closeModalBtn;
    let engineerCountSlider, nptReductionSlider, timeSavingsSlider;
    let engineerCountValue, nptReductionValue, timeSavingsValue, totalSavingsValue;
    
    // --- VIEW & STATE MANAGEMENT ---
    const switchView = (viewName) => {
        appState.currentView = viewName;
        
        views.forEach(v => {
            if (v.id !== 'performer-modal') {
                v.classList.add('hidden');
            }
        });
        document.getElementById(`${viewName}-view`).classList.remove('hidden');

        navLinks.forEach(l => l.classList.remove('active'));
        document.getElementById(`${viewName}-nav-link`)?.classList.add('active');
        
        headerDetails.innerHTML = '';
        
        let viewTitle = viewName.charAt(0).toUpperCase() + viewName.slice(1);
        if(viewName === 'pob') viewTitle = 'POB & ER';
        if(viewName === 'hse') viewTitle = 'HSE & Risk';
        headerTitle.textContent = `Well-Tegra: ${viewTitle}`;

        if (['analyzer', 'commercial', 'hse', 'pob'].includes(viewName)) {
            if(appState.selectedWell && appState.generatedPlan) {
                headerDetails.innerHTML = `<div class="text-right"><p class="text-sm">Well: ${appState.selectedWell.name}</p><p class="text-sm">Job: ${appState.generatedPlan.name}</p></div>`;
            }
            if (viewName === 'commercial') initializeCommercial();
            if (viewName === 'hse') initializeHSE();
            if (viewName === 'pob') initializePOB();
        } else if (viewName === 'logistics') {
            renderAssetManagementViews();
        } else if (viewName === 'home' && !appState.savingsChartInstance) {
            initSavingsChart();
        }
    };
    
    const resetApp = (switchToHome = false) => {
        appState.selectedWell = null;
        appState.selectedObjective = null;
        appState.generatedPlan = null;
        appState.lessonsLearned = [];
        appState.commercial = { afe: 0, actualCost: 0, serviceTickets: [] };
        appState.ai = { selectedProblemId: null, selectedRecommendation: null };
        document.querySelectorAll('.planner-card').forEach(c => c.classList.remove('selected'));
        if(document.querySelector('input[name="objective"]:checked')) {
            document.querySelector('input[name="objective"]:checked').checked = false;
        }
        if(document.querySelector('input[name="problem"]:checked')) {
            document.querySelector('input[name="problem"]:checked').checked = false;
        }
        generatePlanBtnManual.disabled = true;
        generatePlanBtnAi.disabled = true;
        aiRecommendationsContainer.classList.add('hidden');
        aiToggle.checked = false;
        manualPlanningView.classList.remove('hidden');
        aiAdvisorView.classList.add('hidden');
        switchView(switchToHome ? 'home' : 'planner');
        updatePlannerStepUI(1);
    };

    // --- PLANNER LOGIC ---
    const renderWellCards = () => { wellSelectionGrid.innerHTML = wellData.map(well => `<div class="planner-card light-card p-6 cursor-pointer rounded-lg shadow-md" data-well-id="${well.id}"><div class="flex justify-between items-start"><div class="flex-1"><h3 class="text-xl font-bold">${well.name}</h3><p class="text-sm font-medium ${well.id === 'W666' ? 'text-red-500' : 'text-teal-600 dark:text-teal-400'}">${well.field} - ${well.type}</p></div><button class="view-details-btn text-sm text-teal-600 hover:text-teal-800 dark:text-teal-400 dark:hover:text-teal-200 font-semibold" data-well-id="${well.id}">View Details</button></div><div class="mt-4 space-y-2 text-sm"><p><strong>Status:</strong> <span class="font-normal status-${well.status.toLowerCase().replace(/\s/g, '')} px-2 py-1 rounded-full inline-block">${well.status}</span></p><p><strong>Issue:</strong> <span class="font-normal">${well.issue}</span></p></div></div>`).join(''); };
    const renderObjectives = () => { objectivesFieldset.innerHTML = objectivesData.map(obj => `<div><input type="radio" name="objective" id="${obj.id}" value="${obj.id}" class="sr-only"><label for="${obj.id}" class="objective-label flex flex-col p-4 rounded-lg"><span class="font-semibold">${obj.name}</span><span class="text-sm">${obj.description}</span></label></div>`).join(''); };
    const renderProblems = () => { problemsFieldset.innerHTML = problemsData.map(prob => `<div><input type="radio" name="problem" id="${prob.id}" value="${prob.id}" class="sr-only"><label for="${prob.id}" class="problem-label flex flex-col p-4 rounded-lg"><span class="font-semibold">${prob.name}</span><span class="text-sm">${prob.description}</span></label></div>`).join(''); };
    const renderPlan = () => {
        const well = appState.selectedWell, procedure = appState.generatedPlan, riskLabels = ['Operational', 'Geological', 'Equipment', 'HSE', 'Financial'], riskData = Object.values(procedure.risks);
        const getRiskTag = (level) => { if (level <= 2) return `<span class="risk-low px-2 py-1 text-xs font-medium rounded-full">Low</span>`; if (level <= 3) return `<span class="risk-medium px-2 py-1 text-xs font-medium rounded-full">Medium</span>`; return `<span class="risk-high px-2 py-1 text-xs font-medium rounded-full">High</span>`; };
        const logisticsConflicts = checkLogistics();
        let logisticsHtml = logisticsConflicts.length > 0 ? `<div><h4 class="text-xl font-semibold mb-4">Equipment to be Mobilised</h4><ul class="space-y-2">${logisticsConflicts.map(c => `<li class="flex items-start p-3 rounded-md bg-red-50 dark:bg-red-900/50 border-l-4 border-red-400"><span class="text-red-600 mr-2 font-bold">⚠️</span><span class="text-red-800 dark:text-red-300">${c}</span></li>`).join('')}</ul></div>` : '';
        planOutput.innerHTML = `<div><h3 class="text-2xl font-bold">Intervention Plan: ${well.name}</h3><p class="text-lg font-medium text-teal-700 dark:text-teal-400">${appState.selectedObjective.name}</p></div><div class="grid md:grid-cols-3 gap-6 text-center"><div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg"><p class="text-sm font-medium">Selected Well</p><p class="text-lg font-semibold">${well.name}</p></div><div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg"><p class="text-sm font-medium">Est. Duration</p><p class="text-lg font-semibold">${procedure.duration} days</p></div><div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg"><p class="text-sm font-medium">Est. Cost (AFE)</p><p class="text-lg font-semibold">$${procedure.cost.toLocaleString()}</p></div></div>${logisticsHtml}<div><h4 class="text-xl font-semibold mb-4">Baseline Procedure: ${procedure.name}</h4><ol class="list-decimal list-inside space-y-2">${procedure.steps.map(step => `<li>${step}</li>`).join('')}</ol></div><div><h4 class="text-xl font-semibold mb-4">Required Tooling & Equipment</h4><ul class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2">${procedure.tooling.map(tool => `<li class="flex items-center"><span class="text-teal-500 mr-2">&#10003;</span>${tool}</li>`).join('')}</ul></div><div><h4 class="text-xl font-semibold mb-4">Initial Risk Assessment</h4><div class="grid md:grid-cols-2 gap-8 items-center"><div class="space-y-3">${riskLabels.map((label, i) => `<div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-2 rounded"><span class="font-medium">${label}</span>${getRiskTag(riskData[i])}</div>`).join('')}</div><div class="h-64 md:h-80"><canvas id="riskChart"></canvas></div></div></div>`;
        const riskChartCtx = document.getElementById('riskChart').getContext('2d');
        const chartTheme = getChartThemeOptions();
        new Chart(riskChartCtx, { type: 'radar', data: { labels: riskLabels, datasets: [{ label: 'Risk Level', data: riskData, backgroundColor: 'rgba(13, 148, 136, 0.2)', borderColor: 'rgba(13, 148, 136, 1)', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { suggestedMin: 0, suggestedMax: 5, ticks: { display: false }, grid: { color: chartTheme.scales.x.grid.color }, angleLines: { color: chartTheme.scales.x.grid.color }, pointLabels: { color: chartTheme.scales.x.ticks.color } } }, plugins: { legend: { display: false } } } });
    };
    const updatePlannerStepUI = (currentStep) => { Object.values(stepIndicators).forEach(ind => ind.classList.remove('active', 'completed')); for (let i = 1; i < currentStep; i++) { stepIndicators[i].classList.add('completed'); } stepIndicators[currentStep].classList.add('active'); Object.keys(stepSections).forEach(key => stepSections[key].classList.toggle('hidden', key != currentStep)); };

    // --- PERFORMER LOGIC ---
    const initializePerformer = () => {
        appState.liveData = { depth: 0, hookload: 0, pressure: 0, speed: 0, currentStep: 1, isRIH: true, jobRunning: true, alarmState: false, npt: { weather: 0, equipment: 0, operational: 0 }, opTime: 0 };
        appState.logEntries = [{ time: new Date(), user: 'System', text: 'Job initiated.' }];
        appState.generatedPlan.procedure = appState.generatedPlan.steps.map((s, i) => ({ id: i + 1, text: s, completed: false, active: false }));
        if (appState.tfaChartInstance) appState.tfaChartInstance.destroy();
        const chartCtx = document.getElementById('tfaChart').getContext('2d');
        const chartThemeOptions = getChartThemeOptions();
        appState.tfaChartInstance = new Chart(chartCtx, { type: 'line', data: { datasets: [ { label: 'Planned Pick-up', data: appState.generatedPlan.tfaModel.pickUp.map(p => ({x: p[0], y: p[1]})), borderColor: 'rgba(52, 211, 153, 0.8)', borderWidth: 2, pointRadius: 0, tension: 0.1 }, { label: 'Planned Slack-off', data: appState.generatedPlan.tfaModel.slackOff.map(p => ({x: p[0], y: p[1]})), borderColor: 'rgba(96, 165, 250, 0.8)', borderWidth: 2, pointRadius: 0, tension: 0.1 }, { label: 'Upper Alarm', data: appState.generatedPlan.tfaModel.alarmUpper.map(p => ({x: p[0], y: p[1]})), borderColor: 'rgba(239, 68, 68, 0.4)', borderWidth: 1, pointRadius: 0, borderDash: [5, 5], fill: '+1' }, { label: 'Lower Alarm', data: appState.generatedPlan.tfaModel.alarmLower.map(p => ({x: p[0], y: p[1]})), borderColor: 'rgba(239, 68, 68, 0.4)', borderWidth: 1, pointRadius: 0, borderDash: [5, 5], backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: '-1' }, { label: 'Actual Hookload', data: [], borderColor: '#f59e0b', borderWidth: 3, pointRadius: 0, tension: 0.1 } ] }, options: { responsive: true, maintainAspectRatio: false, ...chartThemeOptions } });
        renderPerformerProcedure(); renderPerformerLog();
        updatePerformerState(0);
        performerControls.classList.add('hidden');
        stepForwardBtn.disabled = false;
        stepBackwardBtn.disabled = true;
    };
    const updatePerformerState = (newDepth) => {
        if (!appState.liveData.jobRunning) return;
        appState.liveData.depth = Math.max(0, newDepth);
        const step = appState.generatedPlan.procedure.find(s => s.id === appState.liveData.currentStep);
        if (!step) return;
        const stepText = step.text.toLowerCase();
        appState.liveData.isRIH = stepText.includes('rih') || stepText.includes('run in hole');
        appState.liveData.speed = (stepText.includes('rih') || stepText.includes('pooh')) ? (appState.liveData.isRIH ? 100 : -100) : 0;
        const modelPoints = appState.liveData.isRIH ? appState.generatedPlan.tfaModel.slackOff : appState.generatedPlan.tfaModel.pickUp;
        appState.liveData.hookload = interpolate(modelPoints, appState.liveData.depth) + (Math.random() - 0.5);
        if(appState.liveData.depth > 6000 && appState.liveData.depth < 7000 && appState.liveData.isRIH) { appState.liveData.hookload -= 5; appState.liveData.npt.operational += 0.005; }
        const upperLimit = interpolate(appState.generatedPlan.tfaModel.alarmUpper, appState.liveData.depth);
        const lowerLimit = interpolate(appState.generatedPlan.tfaModel.alarmLower, appState.liveData.depth);
        if (appState.liveData.hookload > upperLimit || appState.liveData.hookload < lowerLimit) { if (!appState.liveData.alarmState) { addLogEntry('System', 'ALARM: Hookload outside envelope!'); appState.liveData.alarmState = true; chartCard.classList.add('alarm'); appState.liveData.npt.equipment += 0.01; } } else { if (appState.liveData.alarmState) { addLogEntry('System', 'INFO: Hookload back in envelope.'); appState.liveData.alarmState = false; chartCard.classList.remove('alarm'); } }
        kpiHookload.textContent = appState.liveData.hookload.toFixed(1); kpiPressure.textContent = Math.round(appState.liveData.pressure); kpiSpeed.textContent = appState.liveData.speed; kpiDepth.textContent = appState.liveData.depth;
        const actualData = appState.tfaChartInstance.data.datasets[4].data;
        const existingPointIndex = actualData.findIndex(p => p.x === appState.liveData.depth);
        if(existingPointIndex > -1) { actualData[existingPointIndex].y = appState.liveData.hookload; } else { actualData.push({ x: appState.liveData.depth, y: appState.liveData.hookload }); }
        actualData.sort((a, b) => a.x - b.x);
        appState.tfaChartInstance.update('none');
        if (appState.liveData.isRIH && appState.liveData.depth >= 9500) { advancePerformerStep(); }
        else if (!appState.liveData.isRIH && appState.liveData.depth <= 0 && stepText.includes('pooh')) { advancePerformerStep(); }
    };
    const renderPerformerProcedure = () => {
        const currentStepId = appState.liveData.currentStep;
        procedureStepsContainer.innerHTML = appState.generatedPlan.procedure.map(step => `<div id="step-${step.id}" data-step-id="${step.id}" class="procedure-step p-3 rounded-md ${step.completed ? 'completed' : ''} ${currentStepId === step.id ? 'active' : ''}"><p class="font-semibold text-sm">${step.id}. ${step.text}</p></div>`).join('');
        const activeStepElement = document.getElementById(`step-${currentStepId}`);
        if (activeStepElement) { activeStepElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    };
    const renderPerformerLog = () => { logEntriesContainer.innerHTML = appState.logEntries.slice().reverse().map(entry => `<div class="log-entry p-2"><p class="text-xs text-gray-400">${entry.time.toLocaleTimeString()} - ${entry.user}</p><p class="text-sm">${entry.text}</p></div>`).join(''); logEntriesContainer.scrollTop = 0; };
    const addLogEntry = (user, text) => { if (!text.trim()) return; appState.logEntries.push({ time: new Date(), user, text }); renderPerformerLog(); };
    const advancePerformerStep = () => {
        const current = appState.generatedPlan.procedure.find(s => s.id === appState.liveData.currentStep); if (current) current.completed = true;
        if (appState.liveData.currentStep < appState.generatedPlan.procedure.length) {
            appState.liveData.currentStep++; const next = appState.generatedPlan.procedure.find(s => s.id === appState.liveData.currentStep); addLogEntry('System', `Starting Step ${next.id}: ${next.text}`); appState.liveData.isRIH = next.text.toLowerCase().includes('rih');
        } else { appState.liveData.jobRunning = false; addLogEntry('System', 'Job procedure complete.'); document.getElementById('job-status').textContent = "● JOB COMPLETE"; document.getElementById('job-status').classList.replace('text-emerald-400', 'text-gray-500'); performerControls.classList.remove('hidden'); stepForwardBtn.disabled = true; stepBackwardBtn.disabled = true; }
        renderPerformerProcedure();
    };
    const jumpToStep = (targetStepId) => {
        addLogEntry('Operator', `Jumping forward to Step ${targetStepId}.`);
        for (let i = appState.liveData.currentStep; i < targetStepId; i++) {
            const stepToComplete = appState.generatedPlan.procedure.find(s => s.id === i);
            if (stepToComplete) {
                stepToComplete.completed = true;
            }
        }
        appState.liveData.currentStep = targetStepId;
        const newStep = appState.generatedPlan.procedure.find(s => s.id === targetStepId);
        addLogEntry('System', `Starting Step ${targetStepId}: ${newStep.text}`);
        let lastDepth = appState.liveData.depth;
        const previousStep = appState.generatedPlan.procedure.find(s => s.id === targetStepId - 1);
        if (previousStep) {
            const prevStepText = previousStep.text.toLowerCase();
            if (prevStepText.includes('rih')) { lastDepth = 9500; }
            else if (prevStepText.includes('pooh')) { lastDepth = 0; }
        }
        updatePerformerState(lastDepth);
        renderPerformerProcedure();
    };
    function interpolate(points, x) { for (let i = 0; i < points.length - 1; i++) { if (x >= points[i][0] && x <= points[i+1][0]) { return points[i][1] + (points[i+1][1] - points[i][1]) * (x - points[i][0]) / (points[i+1][0] - points[i][0]); } } return points[points.length - 1][1]; }

    // --- ANALYZER LOGIC ---
    const initializeAnalyzer = () => {
        analyzerSubtitle.textContent = `Analysis for ${appState.generatedPlan.name} on ${appState.selectedWell.name}`;
        const plannedDuration = appState.generatedPlan.duration;
        const actualDuration = plannedDuration + appState.liveData.npt.weather + appState.liveData.npt.equipment + appState.liveData.npt.operational;
        const plannedCost = appState.generatedPlan.cost;
        const actualCost = appState.commercial.actualCost;
        const renderKPI = (label, plan, actual) => `<div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg"><p class="text-sm font-medium">"${label}"</p><p class="text-lg font-semibold">${actual} <span class="text-sm font-normal">(Plan: ${plan})</span></p></div>`;
        summaryKpis.innerHTML = renderKPI('Job Duration (Days)', plannedDuration.toFixed(1), actualDuration.toFixed(1)) + renderKPI('Total Cost (USD)', `$${plannedCost.toLocaleString()}`, `$${actualCost.toLocaleString()}`);
        if (appState.nptChartInstance) appState.nptChartInstance.destroy();
        const nptCtx = document.getElementById('nptChart').getContext('2d');
        const chartThemeOptions = getChartThemeOptions();
        appState.nptChartInstance = new Chart(nptCtx, { type: 'doughnut', data: { labels: ['Weather', 'Equipment Failure', 'Operational Inefficiency'], datasets: [{ data: [appState.liveData.npt.weather, appState.liveData.npt.equipment, appState.liveData.npt.operational], backgroundColor: ['#3b82f6', '#f97316', '#ef4444'], borderColor: body.classList.contains('theme-dark') ? '#1f2937' : 'white', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: chartThemeOptions.plugins.legend.labels.color } } } } });
        renderLessons();
    };
    const renderLessons = () => { lessonsLearnedList.innerHTML = appState.lessonsLearned.length ? appState.lessonsLearned.map(lesson => `<div class="bg-gray-100 dark:bg-gray-700/50 p-3 rounded-md"><p>${lesson}</p></div>`).join('') : `<p class="text-center">No lessons learned have been added for this job.</p>`; };
    
    // --- ASSET & POB LOGIC ---
    const renderAssetManagementViews = (eqFilter = '', persFilter = '') => {
        equipmentTableBody.innerHTML = equipmentData.filter(e => e.id.toLowerCase().includes(eqFilter.toLowerCase()) || e.type.toLowerCase().includes(eqFilter.toLowerCase())).map(e => `<tr><td class="p-2">${e.id}</td><td class="p-2">${e.type}</td><td class="p-2">${e.location}</td><td class="p-2"><span class="px-2 py-1 text-xs font-medium rounded-full status-${e.testStatus.toLowerCase()}">${e.testStatus}</span></td><td class="p-2"><button class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full hover:bg-blue-200 disabled:opacity-50" ${e.location === 'Onboard - Pump Room' && e.testStatus === 'Pending' ? '' : 'disabled'}>Test</button></td></tr>`).join('');
        personnelTableBody.innerHTML = personnelData.filter(p => p.name.toLowerCase().includes(persFilter.toLowerCase()) || p.role.toLowerCase().includes(persFilter.toLowerCase())).map(p => `<tr><td class="p-2">${p.name}</td><td class="p-2">${p.role}</td><td class="p-2"><span class="px-2 py-1 text-xs font-medium rounded-full status-${p.status.toLowerCase().replace(/\s/g, '')}">${p.status}</span></td><td class="p-2">${p.certsValid ? '✅ Valid' : '❌ Expired'}</td></tr>`).join('');
    };
    const checkLogistics = () => {
        const conflicts = [];
        appState.generatedPlan.tooling.forEach(toolName => { const availableTool = equipmentData.find(e => e.type === toolName && e.status === 'Available'); if (!availableTool) { conflicts.push(`No available equipment of type: <strong>${toolName}</strong>.`); } });
        appState.generatedPlan.personnel.forEach(roleName => { const availablePerson = personnelData.find(p => p.role === roleName && p.status === 'Available'); if (!availablePerson) { conflicts.push(`No available personnel for role: <strong>${roleName}</strong>.`); } else if (!availablePerson.certsValid) { conflicts.push(`Personnel <strong>${availablePerson.name} (${roleName})</strong> has expired certifications.`); } });
        return conflicts;
    };
    const initializePOB = () => {
        appState.pob.personnel = JSON.parse(JSON.stringify(personnelData)).map(p => ({...p, musterStatus: 'Unaccounted'}));
        if(appState.pob.musterInterval) clearInterval(appState.pob.musterInterval);
        appState.pob.musterActive = false;
        renderPOBView();
    };
    const renderPOBView = () => {
        const totalPOB = appState.pob.personnel.length;
        const musteredCount = appState.pob.personnel.filter(p => p.musterStatus === 'Mustered').length;
        musterStations.forEach(ms => { ms.current = appState.pob.personnel.filter(p => p.muster === ms.id && p.musterStatus === 'Mustered').length; });
        const summaryHtml = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><div class="light-card p-6 text-center rounded-lg"><p class="text-sm font-medium">Total POB</p><p class="text-4xl font-bold">${totalPOB}</p></div><div class="light-card p-6 text-center rounded-lg"><p class="text-sm font-medium">Accounted For</p><p class="text-4xl font-bold text-green-600">${musteredCount}</p></div><div class="light-card p-6 text-center rounded-lg"><p class="text-sm font-medium">Unaccounted For</p><p class="text-4xl font-bold text-red-600">${totalPOB - musteredCount}</p></div></div>`;
        const musterStationHtml = musterStations.map(ms => `<div class="light-card p-4 rounded-lg"><h4 class="font-semibold">${ms.name}</h4><p class="text-sm">Capacity: ${ms.capacity}</p><p class="text-2xl font-bold">${ms.current}</p></div>`).join('');
        const pobTableHtml = `<div class="light-card p-6 rounded-lg"><h3 class="text-xl font-semibold mb-4">Live POB Manifest</h3><div class="h-96 overflow-y-auto"><table class="w-full text-sm text-left"><thead class="table-header sticky top-0"><tr><th class="p-2">Name</th><th>Company</th><th>Role</th><th>Muster Station</th><th>Status</th></tr></thead><tbody>${appState.pob.personnel.map(p => `<tr class="border-b table-row-alt dark:border-gray-700"><td class="p-2">${p.name}</td><td class="p-2">${p.company}</td><td class="p-2">${p.role}</td><td class="p-2">${p.muster}</td><td class="p-2"><span class="px-2 py-1 text-xs font-medium rounded-full status-${p.musterStatus.toLowerCase().replace(' ', '')}">${p.musterStatus}</span></td></tr>`).join('')}</tbody></table></div></div>`;
        pobContent.innerHTML = `${summaryHtml}<div class="grid grid-cols-1 md:grid-cols-3 gap-8"><div class="md:col-span-2">${pobTableHtml}</div><div><div class="light-card p-6 rounded-lg"><h3 class="text-xl font-semibold mb-4">Muster Stations</h3><div class="grid grid-cols-2 gap-4">${musterStationHtml}</div></div><div class="mt-8"><button id="muster-drill-btn" class="w-full rounded-md ${appState.pob.musterActive ? 'bg-red-600 hover:bg-red-500' : 'bg-yellow-500 hover:bg-yellow-400'} px-6 py-3 text-base font-semibold text-white shadow-sm">${appState.pob.musterActive ? 'End Muster Drill' : 'Simulate Emergency Muster'}</button></div></div></div>`;
        document.getElementById('muster-drill-btn').addEventListener('click', toggleMusterDrill);
    };
    const toggleMusterDrill = () => {
        appState.pob.musterActive = !appState.pob.musterActive;
        if (appState.pob.musterActive) {
            headerNav.classList.add('emergency-header');
            appState.pob.musterInterval = setInterval(() => {
                const unaccounted = appState.pob.personnel.filter(p => p.musterStatus === 'Unaccounted');
                if (unaccounted.length > 0) {
                    unaccounted[Math.floor(Math.random() * unaccounted.length)].musterStatus = 'Mustered';
                    renderPOBView();
                } else {
                    clearInterval(appState.pob.musterInterval);
                }
            }, 1000);
        } else {
            clearInterval(appState.pob.musterInterval);
            headerNav.classList.remove('emergency-header');
        }
        renderPOBView();
    };

    // --- COMMERCIAL & HSE LOGIC ---
    const initializeCommercial = () => {
        if (!appState.generatedPlan) { commercialContent.innerHTML = `<p class="text-center">Please generate a plan in the Planner module first to view commercial data.</p>`; return; }
        commercialSubtitle.textContent = `Live financial tracking for ${appState.generatedPlan.name} on ${appState.selectedWell.name}`;
        appState.commercial.afe = appState.generatedPlan.cost;
        appState.commercial.actualCost = 0;
        appState.commercial.serviceTickets = [];
        appState.generatedPlan.tooling.forEach(toolName => {
            const tool = equipmentData.find(t => t.type === toolName);
            if(tool) {
                const cost = tool.rate * appState.generatedPlan.duration;
                appState.commercial.serviceTickets.push({ description: `Rental: ${tool.type} (${tool.id})`, cost: cost, validated: true });
                appState.commercial.actualCost += cost;
            }
        });
        renderCommercialView();
    };
    const renderCommercialView = () => {
        const afe = appState.commercial.afe, actual = appState.commercial.actualCost;
        const burnPercent = afe > 0 ? Math.min(100, (actual / afe) * 100) : 0;
        const burnColor = burnPercent > 90 ? 'bg-red-500' : burnPercent > 75 ? 'bg-yellow-500' : 'bg-teal-500';
        commercialContent.innerHTML = `<div class="grid gap-8 lg:grid-cols-3"><div class="lg:col-span-2 light-card p-6 rounded-lg"><h3 class="text-xl font-semibold mb-4">Live AFE vs. Actual</h3><div class="space-y-4"><div class="flex justify-between font-bold text-lg"><span>Actual Cost</span><span>$${actual.toLocaleString()}</span></div><div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4"><div class="${burnColor} h-4 rounded-full" style="width: ${burnPercent}%"></div></div><div class="flex justify-between text-sm"><span>Budget (AFE): $${afe.toLocaleString()}</span><span>${burnPercent.toFixed(1)}% Used</span></div></div><h3 class="text-xl font-semibold mt-8 mb-4">Automated Service Tickets</h3><div class="h-64 overflow-y-auto border dark:border-gray-700 rounded-md"><table class="w-full text-sm text-left"><thead class="table-header sticky top-0"><tr><th class="p-2">Description</th><th>Cost</th><th>Status</th></tr></thead><tbody id="service-ticket-body">${appState.commercial.serviceTickets.map(t => `<tr class="border-b table-row-alt dark:border-gray-700"><td class="p-2">${t.description}</td><td class="p-2">$${t.cost.toLocaleString()}</td><td class="p-2"><span class="status-approved px-2 py-1 text-xs font-medium rounded-full">Validated</span></td></tr>`).join('')}</tbody></table></div></div><div class="light-card p-6 rounded-lg"><h3 class="text-xl font-semibold mb-4">Invoice Validation</h3><p class="text-sm mb-4">Enter a service company invoice amount to check it against validated, system-generated costs.</p><div class="space-y-2"><label for="invoice-amount" class="text-sm font-medium">Invoice Amount (USD)</label><input type="number" id="invoice-amount" class="w-full p-2 rounded-md" placeholder="e.g., 850000"></div><button id="validate-invoice-btn" class="mt-4 w-full rounded-md bg-blue-600 px-4 py-2 text-base font-semibold text-white shadow-sm hover:bg-blue-500">Validate Invoice</button><div id="invoice-result" class="mt-4"></div></div></div>`;
        document.getElementById('validate-invoice-btn').addEventListener('click', validateInvoice);
    };
    const validateInvoice = () => {
        const invoiceAmount = parseFloat(document.getElementById('invoice-amount').value);
        const validatedCost = appState.commercial.actualCost;
        const resultContainer = document.getElementById('invoice-result');
        if(isNaN(invoiceAmount)) { resultContainer.innerHTML = `<div class="p-3 rounded-md bg-yellow-50 dark:bg-yellow-900/50 border-l-4 border-yellow-400 text-yellow-800 dark:text-yellow-300">Please enter a valid amount.</div>`; return; }
        const difference = invoiceAmount - validatedCost;
        if (Math.abs(difference) < 0.01) { resultContainer.innerHTML = `<div class="p-3 rounded-md bg-green-50 dark:bg-green-900/50 border-l-4 border-green-400 text-green-800 dark:text-green-300"><strong>Match!</strong> Invoice amount of $${invoiceAmount.toLocaleString()} matches validated system cost.</div>`;
        } else { resultContainer.innerHTML = `<div class="p-3 rounded-md bg-red-50 dark:bg-red-900/50 border-l-4 border-red-400 text-red-800 dark:text-red-300"><strong>Discrepancy Found!</strong> Invoice is <strong>$${Math.abs(difference).toLocaleString()} ${difference > 0 ? 'over' : 'under'}</strong> system-validated cost.</div>`; }
    };
    const initializeHSE = () => {
        if (!appState.generatedPlan) { hseContent.innerHTML = `<p class="text-center">Please generate a plan in the Planner module first to view job-specific HSE & Risk data.</p>`; return; }
        hseSubtitle.textContent = `Risk register and permits for ${appState.generatedPlan.name} on ${appState.selectedWell.name}`;
        appState.hse.permits = [ { id: 'PTW001', name: 'General Permit to Work', status: 'Approved' }, { id: 'PTW002', name: 'Hot Work Permit', status: 'Pending' }, { id: 'PTW003', name: 'Confined Space Entry', status: 'Approved' }, ];
        appState.hse.riskRegister = [ { hazard: 'Dropped Objects during Rig Up', consequence: 'Personnel Injury', mitigation: 'Establish exclusion zones; secure all items aloft.', risk: 'Medium' }, { hazard: 'Loss of Containment', consequence: 'Environmental Spill', mitigation: 'Verify PCE integrity; function test all valves.', risk: 'High' } ];
        renderHSEView();
    };
    const renderHSEView = () => {
        const riskRegisterHtml = `<div class="light-card p-6 rounded-lg"><h3 class="text-xl font-semibold mb-4">Dynamic Risk Register</h3><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="table-header"><tr><th class="p-2">Hazard</th><th class="p-2">Consequence</th><th class="p-2">Mitigation</th><th class="p-2">Risk Level</th></tr></thead><tbody>${appState.hse.riskRegister.map(r => `<tr class="border-b table-row-alt dark:border-gray-700"><td class="p-2">${r.hazard}</td><td class="p-2">${r.consequence}</td><td class="p-2">${r.mitigation}</td><td class="p-2"><span class="risk-${r.risk.toLowerCase()} px-2 py-1 text-xs font-medium rounded-full">${r.risk}</span></td></tr>`).join('')}</tbody></table></div></div>`;
        const ptwHtml = `<div class="light-card p-6 rounded-lg"><h3 class="text-xl font-semibold mb-4">Permit to Work (PTW) Status</h3><div class="space-y-3">${appState.hse.permits.map(p => `<div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-md"><span class="font-medium">${p.name}</span><span class="px-2 py-1 text-xs font-medium rounded-full status-${p.status.toLowerCase()}">${p.status}</span></div>`).join('')}</div></div>`;
        hseContent.innerHTML = `<div class="grid gap-8 lg:grid-cols-2">${riskRegisterHtml}${ptwHtml}</div>`;
    };
    
    // --- MODAL LOGIC ---
    const openModal = (wellId) => {
        const well = wellData.find(w => w.id === wellId); if (!well) return;
        modalTitle.textContent = `Well History & Schematic: ${well.name}`;
        modalContent.innerHTML = `<div class="mb-4 border-b dark:border-gray-700"><nav class="-mb-px flex space-x-8" aria-label="Tabs"><a href="#" class="modal-tab active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="history">History & Schematic</a><a href="#" class="modal-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="reports">Daily Reports</a></nav></div><div id="modal-tab-history"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-2"><h4 class="text-xl font-semibold mb-4">Operational History</h4><div id="history-content" class="max-h-96 overflow-y-auto pr-2"></div></div><div class="md:col-span-1"><h4 class="text-xl font-semibold mb-4">Wellbore Schematic</h4><div class="bg-white dark:bg-slate-800 p-2 rounded-lg shadow-inner border dark:border-slate-700">${renderWellSchematic(well)}</div></div></div></div><div id="modal-tab-reports" class="hidden"><h4 class="text-xl font-semibold mb-4">Daily Reports (from legacy spreadsheets)</h4><div id="reports-content" class="h-96 overflow-y-auto"></div></div>`;
        renderModalTabs(well);
        document.querySelectorAll('.modal-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById('modal-tab-history').classList.toggle('hidden', e.target.dataset.tab !== 'history');
                document.getElementById('modal-tab-reports').classList.toggle('hidden', e.target.dataset.tab !== 'reports');
            });
        });
        modal.classList.remove('hidden');
    };
    const renderModalTabs = (well) => {
        document.getElementById('history-content').innerHTML = well.history.length ? well.history.map(h => `<div class="p-4 mb-4 border dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/50"><p class="font-bold text-lg">${h.operation} <span class="text-sm font-normal">- ${h.date}</span></p><div class="mt-2 pl-4 border-l-2 border-gray-200 dark:border-gray-600"><p class="text-sm"><strong class="text-red-600">Problem:</strong> ${h.problem}</p><p class="text-sm mt-1"><strong class="text-green-600">Lesson Learned:</strong> ${h.lesson}</p></div></div>`).join('') : '<p>No historical data available.</p>';
        document.getElementById('reports-content').innerHTML = well.dailyReports.length ? `<table class="w-full text-sm text-left"><thead class="table-header"><tr><th class="p-2">Date</th><th class="p-2">Summary</th><th class="p-2">NPT (hrs)</th></tr></thead><tbody>${well.dailyReports.map(r => `<tr class="border-b table-row-alt dark:border-gray-700"><td class="p-2">${r.date}</td><td class="p-2">${r.summary}</td><td class="p-2">${r.npt}</td></tr>`).join('')}</tbody></table>` : '<p>No daily reports available.</p>';
    };
    const closeModal = () => modal.classList.add('hidden');
    const renderWellSchematic = (well) => {
        const isDark = body.classList.contains('theme-dark');
        const maxDepth = 20000; // Use a fixed max depth for consistent scaling
        let svgContent = `<svg viewBox="0 0 150 600" class="w-full h-auto"><g class="schematic-depth-marker" text-anchor="end" fill="${isDark ? '#94a3b8' : '#1d4ed8'}"><text x="25" y="53">0k</text><line x1="28" y1="50" x2="35" y2="50" stroke="${isDark ? '#4b5563' : '#d1d5db'}" stroke-width="1"/><text x="25" y="203">5k</text><line x1="28" y1="200" x2="35" y2="200" stroke="${isDark ? '#4b5563' : '#d1d5db'}" stroke-width="1"/><text x="25" y="353">10k</text><line x1="28" y1="350" x2="35" y2="350" stroke="${isDark ? '#4b5563' : '#d1d5db'}" stroke-width="1"/><text x="25" y="503">15k</text><line x1="28" y1="500" x2="35" y2="500" stroke="${isDark ? '#4b5563' : '#d1d5db'}" stroke-width="1"/></g><rect x="40" y="0" width="100" height="600" fill="${isDark ? '#281e14' : '#eaddc7'}" /><rect x="50" y="0" width="80" height="600" fill="${isDark ? '#3a2d21' : '#d2b48c'}" /><rect x="50" y="20" width="80" height="10" fill="${isDark ? '#4b5563' : '#9ca3af'}"/><rect x="75" y="10" width="30" height="10" fill="${isDark ? '#6b7280' : '#6b7280'}"/>`;
        well.completion.casing?.forEach(c => { const topY = (c.top / maxDepth) * 600; const height = ((c.bottom - c.top) / maxDepth) * 600; svgContent += `<rect x="60" y="${topY}" width="60" height="${height}" fill="none" stroke="${c.isProblem ? '#ef4444' : '#6b7280'}" stroke-width="2"/>`; });
        well.completion.tubing?.forEach(t => { const topY = (t.top / maxDepth) * 600; const height = ((t.bottom - c.top) / maxDepth) * 600; svgContent += `<rect x="85" y="${topY}" width="10" height="${height}" fill="${isDark ? '#6b7280' : '#d1d5db'}" stroke="${isDark ? '#4b5563' : '#9ca3af'}" stroke-width="0.5"/>`; });
        well.completion.equipment?.forEach(e => { const y = (e.top / maxDepth) * 600; if(e.item.includes('Packer')) { svgContent += `<polygon points="75,${y-10} 105,${y-10} 110,${y} 70,${y}" fill="${isDark ? '#9ca3af' : '#4b5563'}"/>`; } else if (e.item.includes('SSSV')) { svgContent += `<rect x="82" y="${y}" width="16" height="20" class="${e.isProblem ? 'stroke-red-500 fill-red-200/50' : 'fill-gray-400'}" stroke-width="1"/><path d="M 85 ${y+3} l 10 14 M 85 ${y+17} l 10 -14" stroke="${e.isProblem ? '#ef4444' : '#6b7280'}" stroke-width="1.5"/>`; } else if (e.item.includes('Scale')) { svgContent += `<path d="M 85 ${y-10} C 80 ${y}, 80 ${y+10}, 85 ${y+20}" stroke="#c2410c" stroke-width="2" fill="none" stroke-linecap="round"/><path d="M 95 ${y-10} C 100 ${y}, 100 ${y+10}, 95 ${y+20}" stroke="#c2410c" stroke-width="2" fill="none" stroke-linecap="round"/>`; } else if (e.item.includes('Shale')) { svgContent += `<rect x="40" y="${y}" width="100" height="100" fill="rgba(239, 68, 68, 0.1)" /><text x="75" y="${y+50}" class="schematic-label" text-anchor="middle" fill="#ef4444">${e.item}</text>`; } });
        well.completion.perforations?.forEach(p => { const topY = (p.top / maxDepth) * 600; const bottomY = (p.bottom / maxDepth) * 600; for(let y = topY; y <= bottomY; y += 10) { svgContent += `<path d="M 60 ${y} L 40 ${y}" stroke="${p.isProblem ? '#ef4444' : '#1d4ed8'}" stroke-width="1.5" />`; if(p.isProblem) svgContent += `<path d="M 40 ${y} l 4 4 m -4 0 l 4 -4" stroke="#ef4444" stroke-width="1.5"/>`; } });
        well.completion.plugs?.forEach(p => { const topY = (p.top / maxDepth) * 600; const height = ((p.bottom - c.top) / maxDepth) * 600; svgContent += `<rect x="55" y="${topY}" width="70" height="${height}" fill="#a8a29e"/>`; });
        svgContent += `</svg>`; return svgContent;
    };

    // --- THEME & CHART LOGIC ---
    const setTheme = (theme) => {
        body.className = `theme-${theme}`;
        localStorage.setItem('theme', theme);
        if(appState.currentView === 'performer') body.classList.add('theme-dark');

        Object.values(appState).forEach(s => {
            if (s && s instanceof Chart) {
                const chartTheme = getChartThemeOptions();
                s.options.scales.x.grid.color = chartTheme.scales.x.grid.color;
                s.options.scales.x.ticks.color = chartTheme.scales.x.ticks.color;
                s.options.scales.y.grid.color = chartTheme.scales.y.grid.color;
                s.options.scales.y.ticks.color = chartTheme.scales.y.ticks.color;
                if(s.options.plugins.legend) s.options.plugins.legend.labels.color = chartTheme.plugins.legend.labels.color;
                if(s.config.type === 'doughnut') s.data.datasets[0].borderColor = theme === 'dark' ? '#1f2937' : 'white';
                s.update();
            }
        });
    };
    const getChartThemeOptions = () => {
        const isDark = body.classList.contains('theme-dark');
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : '#d1d5db';
        const textColor = isDark ? '#d1d5db' : '#4b5563';
        return {
            scales: { x: { grid: { color: gridColor }, ticks: { color: textColor }, title: { display: true, text: 'Depth (ft)', color: textColor } }, y: { grid: { color: gridColor }, ticks: { color: textColor }, title: { display: true, text: 'Hookload (klbf)', color: textColor } } },
            plugins: { legend: { labels: { color: textColor } } }
        };
    };

    // --- ROI CALCULATOR LOGIC (Home Page) ---
    const calculateROI = () => {
        const engineers = parseInt(engineerCountSlider.value);
        const nptReduction = parseInt(nptReductionSlider.value) / 100;
        const timeSavings = parseInt(timeSavingsSlider.value) / 100;

        const avgEngineerSalary = 120000;
        const avgNptCostPerDay = 250000;
        const avgNptDaysPerYear = 15;

        const engineerSavings = engineers * avgEngineerSalary * timeSavings;
        const nptSavings = avgNptCostPerDay * avgNptDaysPerYear * nptReduction;
        const totalSavings = engineerSavings + nptSavings;

        engineerCountValue.textContent = engineers;
        nptReductionValue.textContent = `${nptReduction * 100}%`;
        timeSavingsValue.textContent = `${timeSavings * 100}%`;
        totalSavingsValue.textContent = `$${Math.round(totalSavings).toLocaleString()}`;

        updateSavingsChart(engineerSavings, nptSavings);
    };

    const updateSavingsChart = (engineerSavings, nptSavings) => {
        if(appState.savingsChartInstance) {
            appState.savingsChartInstance.data.datasets[0].data = [engineerSavings, nptSavings];
            appState.savingsChartInstance.update();
        }
    };

    const initSavingsChart = () => {
        if (appState.savingsChartInstance) {
            appState.savingsChartInstance.destroy();
        }
        const savingsChartCanvas = document.getElementById('savingsChart');
        if (savingsChartCanvas) {
            const ctx = savingsChartCanvas.getContext('2d');
            appState.savingsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Engineering Time', 'NPT Reduction'],
                    datasets: [{
                        label: 'Annual Savings',
                        data: [0, 0],
                        backgroundColor: ['#0d9488', '#0891b2'],
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            ticks: {
                                callback: (value) => `$${(value / 1000).toLocaleString()}k`,
                                color: '#94a3b8'
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
            calculateROI();
        }
    };
    
    // --- INITIALIZATION ---
    const init = () => {
        // Assign all DOM elements
        body = document.body;
        views = document.querySelectorAll('.view-container');
        navLinks = document.querySelectorAll('.nav-link');
        headerTitle = document.getElementById('header-title');
        headerDetails = document.getElementById('header-details');
        headerNav = document.getElementById('header-nav');
        stepIndicators = { 1: document.getElementById('step-1-indicator'), 2: document.getElementById('step-2-indicator'), 3: document.getElementById('step-3-indicator') };
        stepSections = { 1: document.getElementById('step-1'), 2: document.getElementById('step-2'), 3: document.getElementById('step-3') };
        wellSelectionGrid = document.getElementById('well-selection-grid');
        objectivesFieldset = document.getElementById('objectives-fieldset');
        problemsFieldset = document.getElementById('problems-fieldset');
        generatePlanBtnManual = document.getElementById('generate-plan-btn-manual');
        generatePlanBtnAi = document.getElementById('generate-plan-btn-ai');
        planOutput = document.getElementById('plan-output');
        startOverBtn = document.getElementById('start-over-btn');
        beginOpBtn = document.getElementById('begin-op-btn');
        aiToggle = document.getElementById('ai-toggle');
        manualPlanningView = document.getElementById('manual-planning-view');
        aiAdvisorView = document.getElementById('ai-advisor-view');
        aiRecommendationsContainer = document.getElementById('ai-recommendations');
        performerModal = document.getElementById('performer-modal');
        closePerformerBtn = document.getElementById('close-performer-btn');
        kpiHookload = document.getElementById('kpi-hookload');
        kpiPressure = document.getElementById('kpi-pressure');
        kpiSpeed = document.getElementById('kpi-speed');
        kpiDepth = document.getElementById('kpi-depth');
        procedureStepsContainer = document.getElementById('procedure-steps');
        logEntriesContainer = document.getElementById('log-entries');
        logInput = document.getElementById('log-input');
        addLogBtn = document.getElementById('add-log-btn');
        chartCard = document.getElementById('chart-card');
        performerControls = document.getElementById('performer-controls');
        viewAnalysisBtn = document.getElementById('view-analysis-btn');
        stepForwardBtn = document.getElementById('step-forward-btn');
        stepBackwardBtn = document.getElementById('step-backward-btn');
        analyzerSubtitle = document.getElementById('analyzer-subtitle');
        summaryKpis = document.getElementById('summary-kpis');
        lessonsLearnedList = document.getElementById('lessons-learned-list');
        lessonInput = document.getElementById('lesson-input');
        addLessonBtn = document.getElementById('add-lesson-btn');
        planNewJobBtn = document.getElementById('plan-new-job-btn');
        equipmentTableBody = document.getElementById('equipment-table-body');
        personnelTableBody = document.getElementById('personnel-table-body');
        equipmentSearch = document.getElementById('equipment-search');
        personnelSearch = document.getElementById('personnel-search');
        commercialContent = document.getElementById('commercial-content');
        commercialSubtitle = document.getElementById('commercial-subtitle');
        hseContent = document.getElementById('hse-content');
        hseSubtitle = document.getElementById('hse-subtitle');
        pobContent = document.getElementById('pob-content');
        modal = document.getElementById('well-history-modal');
        modalTitle = document.getElementById('modal-title');
        modalContent = document.getElementById('modal-content');
        closeModalBtn = document.getElementById('close-modal-btn');
        engineerCountSlider = document.getElementById('engineerCount');
        nptReductionSlider = document.getElementById('nptReduction');
        timeSavingsSlider = document.getElementById('timeSavings');
        engineerCountValue = document.getElementById('engineerCountValue');
        nptReductionValue = document.getElementById('nptReductionValue');
        timeSavingsValue = document.getElementById('timeSavingsValue');
        totalSavingsValue = document.getElementById('totalSavings');

        // Attach all event listeners
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                switchView(e.currentTarget.id.replace('-nav-link', ''));
            });
        });
        if(wellSelectionGrid) {
            wellSelectionGrid.addEventListener('click', (e) => {
                if (e.target.closest('.view-details-btn')) { e.stopPropagation(); openModal(e.target.closest('.view-details-btn').dataset.wellId); return; }
                const card = e.target.closest('.planner-card'); if (!card) return;
                appState.selectedWell = wellData.find(w => w.id === card.dataset.wellId);
                document.querySelectorAll('.planner-card').forEach(c => c.classList.remove('selected', 'border-red-500'));
                card.classList.add('selected');
                if (card.dataset.wellId === 'W666') {
                    card.classList.add('border-red-500'); // Special border for the special well
                } else {
                     card.classList.add('border-teal-500');
                }
                updatePlannerStepUI(2);
            });
        }
        if(objectivesFieldset) objectivesFieldset.addEventListener('change', (e) => { appState.selectedObjective = objectivesData.find(o => o.id === e.target.value); generatePlanBtnManual.disabled = !appState.selectedObjective; });
        if(problemsFieldset) problemsFieldset.addEventListener('change', (e) => {
            appState.ai.selectedProblemId = e.target.value;
            const recommendations = aiRecommendations[appState.ai.selectedProblemId] || [];
            aiRecommendationsContainer.innerHTML = `<h3 class="text-lg font-semibold text-center mb-4 mt-6">AI Recommendations</h3><div class="space-y-4">${recommendations.map((rec, i) => { const objective = objectivesData.find(o => o.id === rec.objectiveId); return `<div class="ai-recommendation-card p-4 rounded-lg" data-rec-index="${i}"><div class="flex justify-between items-start"><h4 class="font-bold text-lg text-teal-700 dark:text-teal-400">${objective.name}</h4><span class="text-sm font-medium">${rec.confidence}% Confidence</span></div><p class="text-sm mt-1"><strong>Projected Outcome:</strong> ${rec.outcome}</p><p class="text-xs mt-2"><strong>Reasoning:</strong> ${rec.reason}</p></div>`; }).join('')}</div>`;
            aiRecommendationsContainer.classList.remove('hidden');
            document.querySelectorAll('.ai-recommendation-card').forEach(card => card.addEventListener('click', (ev) => {
                const selectedCard = ev.target.closest('.ai-recommendation-card');
                const recIndex = parseInt(selectedCard.dataset.recIndex);
                appState.ai.selectedRecommendation = aiRecommendations[appState.ai.selectedProblemId][recIndex];
                document.querySelectorAll('.ai-recommendation-card').forEach(c => c.classList.remove('selected'));
                selectedCard.classList.add('selected');
                generatePlanBtnAi.disabled = false;
            }));
        });
        if(aiToggle) aiToggle.addEventListener('change', (e) => { manualPlanningView.classList.toggle('hidden', e.target.checked); aiAdvisorView.classList.toggle('hidden', !e.target.checked); });
        if(generatePlanBtnManual) generatePlanBtnManual.addEventListener('click', () => { if (!appState.selectedWell || !appState.selectedObjective) return; appState.generatedPlan = proceduresData[appState.selectedObjective.id]; renderPlan(); updatePlannerStepUI(3); });
        if(generatePlanBtnAi) generatePlanBtnAi.addEventListener('click', () => { if (!appState.selectedWell || !appState.ai.selectedRecommendation) return; appState.selectedObjective = objectivesData.find(o => o.id === appState.ai.selectedRecommendation.objectiveId); appState.generatedPlan = proceduresData[appState.selectedObjective.id]; renderPlan(); updatePlannerStepUI(3); });
        if(startOverBtn) startOverBtn.addEventListener('click', () => resetApp(false));
        if(beginOpBtn) beginOpBtn.addEventListener('click', () => { if (!appState.generatedPlan) return; performerModal.classList.remove('hidden'); initializePerformer(); });
        if(closePerformerBtn) closePerformerBtn.addEventListener('click', () => performerModal.classList.add('hidden'));
        if(addLogBtn) addLogBtn.addEventListener('click', () => { addLogEntry('Operator', logInput.value); logInput.value = ''; });
        if(procedureStepsContainer) procedureStepsContainer.addEventListener('click', (e) => {
            const stepDiv = e.target.closest('.procedure-step');
            if (!stepDiv || !appState.liveData.jobRunning) return;

            const targetStepId = parseInt(stepDiv.dataset.stepId);
            const currentStepId = appState.liveData.currentStep;
            
            if (targetStepId > currentStepId) {
                jumpToStep(targetStepId);
            }
        });
        if(viewAnalysisBtn) viewAnalysisBtn.addEventListener('click', () => { switchView('analyzer'); initializeAnalyzer(); });
        if(addLessonBtn) addLessonBtn.addEventListener('click', () => { if(lessonInput.value.trim()){ appState.lessonsLearned.push(lessonInput.value.trim()); lessonInput.value = ''; renderLessons(); } });
        if(planNewJobBtn) planNewJobBtn.addEventListener('click', () => resetApp(true));
        if(stepForwardBtn) stepForwardBtn.addEventListener('click', () => { const stepText = appState.generatedPlan.procedure.find(s => s.id === appState.liveData.currentStep).text.toLowerCase(); if (stepText.includes('rih') || stepText.includes('pooh')) { const newDepth = Math.min(9500, appState.liveData.depth + 250); updatePerformerState(newDepth); stepBackwardBtn.disabled = false; } else { advancePerformerStep(); } });
        if(stepBackwardBtn) stepBackwardBtn.addEventListener('click', () => { const stepText = appState.generatedPlan.procedure.find(s => s.id === appState.liveData.currentStep).text.toLowerCase(); if (stepText.includes('rih') || stepText.includes('pooh')) { const newDepth = Math.max(0, appState.liveData.depth - 250); updatePerformerState(newDepth); if(newDepth === 0) stepBackwardBtn.disabled = true; } });
        if(equipmentSearch) equipmentSearch.addEventListener('input', (e) => renderAssetManagementViews(e.target.value, personnelSearch.value));
        if(personnelSearch) personnelSearch.addEventListener('input', (e) => renderAssetManagementViews( equipmentSearch.value, e.target.value));
        if(closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
        if(modal) modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        if(engineerCountSlider) engineerCountSlider.addEventListener('input', calculateROI);
        if(nptReductionSlider) nptReductionSlider.addEventListener('input', calculateROI);
        if(timeSavingsSlider) timeSavingsSlider.addEventListener('input', calculateROI);

        // The rest of the init logic
        renderWellCards();
        renderObjectives();
        renderProblems();
        switchView('home');
    };

    init();
});
</script>

</body>
</html>